name: Auto Build & Release

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  auto-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Main Repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 

    # --- 1. VERSIONING ---
    - name: Bump Version and Push Tag
      id: tag_version
      uses: mathieudutour/github-tag-action@v6.1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        default_bump: patch
        release_branches: main,master

    # --- 2. SETUP ENVIRONMENT ---
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10' 

    - name: Create Directory Structure
      run: |
        New-Item -ItemType Directory -Force -Path "Build\Admin\Mods"
        New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\Documents\Battlefield 3\Server\Admin\Mods"

    # --- 3. CLONE & LOGGING ---
    - name: Clone RealityMod & Mods
      working-directory: Build/Admin/Mods
      env:
        GH_TOKEN: ${{ secrets.GH_PAT }}
      run: |
        # Optimization: Increased depth to 5 to fetch enough history for log -3
        git clone --depth 5 --recurse-submodules https://oauth2:$env:GH_TOKEN@github.com/BF3RM/RealityMod.git
        git clone --depth 5 https://oauth2:$env:GH_TOKEN@github.com/BF3RM/BlueprintManager.git
        git clone --depth 5 https://oauth2:$env:GH_TOKEN@github.com/BF3RM/VEManager.git
    
        cd RealityMod
        $rm_log = (git log -3 --format="%h - %s") -join '<br>'
        "RM_LOG=$rm_log" >> $env:GITHUB_ENV
        cd ..
        
        cd BlueprintManager
        $bp_log = (git log -3 --format="%h - %s") -join '<br>'
        "BP_LOG=$bp_log" >> $env:GITHUB_ENV
        cd ..
        
        cd VEManager
        $ve_log = (git log -3 --format="%h - %s") -join '<br>'
        "VE_LOG=$ve_log" >> $env:GITHUB_ENV

    - name: Clone RMLevelLoaderGen
      working-directory: ${{ github.workspace }}
      env:
        GH_TOKEN: ${{ secrets.GH_PAT }}
      run: |
        # Optimization: Increased depth to 5
        git clone --depth 5 --recurse-submodules https://oauth2:$env:GH_TOKEN@github.com/BF3RM/RMLevelLoaderGen.git temp_loader
        
        # --- LOGGING ---
        cd temp_loader
        $ll_log = (git log -3 --format="%h - %s") -join '<br>'
        "LL_LOG=$ll_log" >> $env:GITHUB_ENV

    # --- 4. CACHE LOGIC: LEVEL LOADER ---
    - name: Get LevelLoader Commit Hash
      id: levelloader_hash
      working-directory: temp_loader
      run: |
        $hash = git rev-parse HEAD
        echo "hash=$hash" >> $env:GITHUB_OUTPUT

    - name: Cache LevelLoader Output
      id: cache-levelloader
      uses: actions/cache@v4
      with:
        path: Build/Admin/Mods/rm-levelloader
        key: levelloader-output-${{ steps.levelloader_hash.outputs.hash }}

    - name: Run Generator (Only on Cache Miss)
      if: steps.cache-levelloader.outputs.cache-hit != 'true'
      working-directory: temp_loader
      run: |
        # Mark as Updated for Release Notes
        echo "LL_STATUS=**(UPDATED)**" >> $env:GITHUB_ENV
        
        # Patch Bat File: Remove 'pause' and fix slash direction
        $content = Get-Content generate.bat -Raw
        $content = $content -replace 'pause', 'REM pause'
        $content = $content -replace '/', '\' 
        Set-Content -Path generate.bat -Value $content

        # Run the batch file (which triggers the Python code)
        cmd /c generate.bat

        $Dest = "..\Build\Admin\Mods\rm-levelloader"
        if (Test-Path "mods\rm-levelloader") {
            Move-Item -Path "mods\rm-levelloader" -Destination $Dest -Force
        } elseif (Test-Path "$env:USERPROFILE\Documents\Battlefield 3\Server\Admin\Mods\RMLevelLoaderGen\mods\rm-levelloader") {
             Move-Item -Path "$env:USERPROFILE\Documents\Battlefield 3\Server\Admin\Mods\RMLevelLoaderGen\mods\rm-levelloader" -Destination $Dest -Force
        } else {
             Write-Error "FATAL: Output missing after generation"; exit 1
        }

    # --- 5. CACHE LOGIC: WEB UI ---
    - name: Cache WebUI Output
      id: cache-webui
      uses: actions/cache@v4
      with:
        path: Build/Admin/Mods/RealityMod/ui.vuic
        key: webui-vuic-${{ hashFiles('vextpack/**', 'Build/Admin/Mods/RealityMod/WebUI/pnpm-lock.yaml') }}

    # --- 6. BUILD WEB UI (Only on Cache Miss) ---
    - name: Install pnpm
      if: steps.cache-webui.outputs.cache-hit != 'true'
      uses: pnpm/action-setup@v2
      with:
        version: 9

    - name: Setup Node
      if: steps.cache-webui.outputs.cache-hit != 'true'
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: 'Build/Admin/Mods/RealityMod/WebUI/pnpm-lock.yaml'

    - name: Build WebUI
      if: steps.cache-webui.outputs.cache-hit != 'true'
      working-directory: Build/Admin/Mods/RealityMod/WebUI
      run: |
        # Mark as Updated for Release Notes
        echo "RM_STATUS=**(UPDATED)**" >> $env:GITHUB_ENV

        pnpm install
        $Source = "${{ github.workspace }}\vextpack"
        $Dest = "node_modules\vextpack"
        if (Test-Path $Source) { Copy-Item -Path $Source -Destination $Dest -Recurse -Force }
        pnpm build
        if (-not (Test-Path "..\ui.vuic")) { Write-Error "FAILURE: ui.vuic missing"; exit 1 }

    # --- 7. CONFIG FILES ---
    - name: Generate Config Files
      working-directory: Build/Admin
      env:
        RCON_PW: ${{ secrets.RCON_PASSWORD }} 
        LIC_KEY: ${{ secrets.LICENSE_KEY }}
      run: |
        New-Item -Path "BanList.txt" -ItemType File -Force
        Set-Content -Path "ModList.txt" -Value "RealityMod`r`nrm-levelloader`r`nBlueprintManager`r`nVEManager"

        $mapListContent = @"
        #AAS Layers
        #XP1_001 AdvanceAndSecureStd 1 # Strike at Karkand
        #XP1_002 AdvanceAndSecureStd 1 # Gulf of Oman
        #XP1_003 AdvanceAndSecureStd 1 # Sharqi Peninsula
        #XP1_004 AdvanceAndSecureStd 1 # Wake Island
        #XP3_Desert AdvanceAndSecureStd 1 # Bandar Desert
        #XP3_Shield AdvanceAndSecureStd 6 # Issue 226
        #XP4_Parl AdvanceAndSecureStd 1 # Azadi Palace
        #XP5_001 AdvanceAndSecureStd 1 # Operation Riverside
        XP5_002 AdvanceAndSecureStd 1 # Kandahar
        #XP5_003 AdvanceAndSecureStd 1 # Bay of Gdansk
        #XP5_004 AdvanceAndSecureStd 1 # Chernihivska Oblast Pipeline

        #Skirmish Layers
        #XP1_001 SkirmishStd 1 # Strike at Karkand
        #XP1_002 SkirmishStd 1 # Gulf of Oman
        #XP1_003 SkirmishStd 1 # Sharqi Peninsula
        #XP1_004 SkirmishStd 1 # Wake Island
        #XP3_Desert SkirmishStd 1 # Bandar Desert
        #XP3_Shield SkirmishStd 6 # Issue 226
        #XP4_Parl SkirmishStd 1 # Azadi Palace
        #XP5_001 SkirmishStd 1 # Operation Riverside
        #XP5_002 SkirmishStd 1 # Kandahar
        #XP5_003 SkirmishStd 1 # Bay of Gdansk
        #XP5_004 SkirmishStd 1 # Chernihivska Oblast Pipeline


        #Insurgency Layers
        #XP1_001 InsurgencyStd 1 # Strike at Karkand
        #XP1_002 InsurgencyStd 1 # Gulf of Oman
        #XP1_003 InsurgencyStd 1 # Sharqi Peninsula
        #XP3_Desert InsurgencyStd 1 # Bandar Desert
        #XP4_Parl InsurgencyStd 1  # Azadi Palace
        #XP5_002 InsurgencyStd 1

        #XP3_Desert TrainingStd 1 # Bandar Desert
        "@
        Set-Content -Path "MapList.txt" -Value $mapListContent

        $startupContent = @"
        # RM Server Startup.txt Example
        admin.password "$env:RCON_PW"
        vars.gamePassword "password"
        vars.serverName "<Server Name>"
        vars.maxPlayers 80
        vu.serverbanner https://i.imgur.com/B4bCwpq.jpg 
        vars.idleTimeout 9999
        vars.teamKillCountForKick 0
        vars.teamKillValueForKick 2
        vars.teamKillValueIncrease 0.525
        vars.teamKillValueDecreasePerSecond 0.01
        vars.teamKillKickForBan 0
        RM.setDevelopers "names" "space" "seperated" 
        RM.setAdmins "Admin1" "Admin2"
        RM.setLightAdmins "LightAdmin1" "LightAdmin2"
        RM.serverInfo "Sample RM Server Info"
        RM.serverLicenseKey $env:LIC_KEY
        RM.ingameBanner https://i.imgur.com/Vth3wBa.jpg
        RM.pingLimitEnable true
        RM.pingLimitInMs 250
        RM.autoPerfEnabled false
        RM.autoPerfMaxPlayers 80
        RM.tempReservedSlotsEnabled true
        RM.tempReservedSlotsRejoinTime 60.0
        RM.defaultPreRoundTime 180
        RM.setAutoBalancer false
        reservedSlotsList.add "PlayerName1"
        reservedSlotsList.add "PlayerName2"
        "@
        Set-Content -Path "Startup.txt" -Value $startupContent

    # --- 8. PACKAGE & RELEASE ---
    - name: Create Zip Packages
      run: |
        # Optimization: Use 7zip (faster than Compress-Archive)
        # We change directory to avoid including parent folders in zip structure
        
        pushd Build
        7z a -tzip ..\Reality-Server-Full.zip * -r
        popd

        pushd Build\Admin\Mods
        7z a -tzip ..\..\..\Reality-Mods-Only.zip * -r
        popd

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag_version.outputs.new_tag }}
        name: Release ${{ steps.tag_version.outputs.new_tag }}
        files: |
          Reality-Server-Full.zip
          Reality-Mods-Only.zip
        body: |
          Automated Release ${{ steps.tag_version.outputs.new_tag }}
          
          ### ðŸ“¦ Component Status
          | Component | Status | Last 3 Commits |
          | :--- | :--- | :--- |
          | **RealityMod** | ${{ env.RM_STATUS }} | ${{ env.RM_LOG }} |
          | **LevelLoader** | ${{ env.LL_STATUS }} | ${{ env.LL_LOG }} |
          | **BlueprintManager** | (Included) | ${{ env.BP_LOG }} |
          | **VEManager** | (Included) | ${{ env.VE_LOG }} |

          ### ðŸ”§ Bundler Changelog
          ${{ steps.tag_version.outputs.changelog }}

    # --- 9. UPDATE LATEST TAG (Add tag to same commit) ---
    - name: Update 'latest' Tag
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git tag -f latest
        git push -f origin latest