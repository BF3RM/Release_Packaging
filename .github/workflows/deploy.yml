name: Build BF3 Reality Mod Server

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout Main Repo
      uses: actions/checkout@v4

    # --- SETUP ENVIRONMENTS ---
    - name: Setup Dotnet (For compiling the C# tool)
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '6.0.x'

    - name: Setup Python (In case the tool relies on Python scripts)
      uses: actions/setup-python@v5
      with:
        python-version: '3.10' 

    - name: Create Directory Structure
      run: |
        New-Item -ItemType Directory -Force -Path "Build\Admin\Mods"
        New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\Documents\Battlefield 3\Server\Admin\Mods"

    # --- 1. CLONE REALITYMOD & MODS ---
    - name: Clone RealityMod & Mods
      working-directory: Build/Admin/Mods
      env:
        GH_TOKEN: ${{ secrets.GH_PAT }}
      run: |
        git clone --recurse-submodules https://oauth2:$env:GH_TOKEN@github.com/BF3RM/RealityMod.git
        git clone https://oauth2:$env:GH_TOKEN@github.com/BF3RM/BlueprintManager.git
        git clone https://oauth2:$env:GH_TOKEN@github.com/BF3RM/VEManager.git

    # --- 2. INSTALL PNPM ---
    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9

    # --- 3. SETUP NODE & CACHE ---
    - name: Setup Node.js with Caching
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'
        cache-dependency-path: 'Build/Admin/Mods/RealityMod/WebUI/pnpm-lock.yaml'

    # --- 4. BUILD WEBUI ---
    - name: Install & Inject Vextpack & Build
      working-directory: Build/Admin/Mods/RealityMod/WebUI
      run: |
        pnpm install

        $Source = "${{ github.workspace }}\vextpack"
        $Dest = "node_modules\vextpack"
        
        if (Test-Path $Source) {
            Copy-Item -Path $Source -Destination $Dest -Recurse -Force
        }

        pnpm build
        
        if (-not (Test-Path "..\ui.vuic")) {
            Write-Error "FAILURE: ui.vuic was not found in RealityMod root!"
            exit 1
        }

    # --- 5. RM LEVEL LOADER GEN ---
    - name: Run RMLevelLoaderGen
      working-directory: ${{ github.workspace }}
      env:
        GH_TOKEN: ${{ secrets.GH_PAT }}
      run: |
        # 1. Clone Recursively
        git clone --recurse-submodules https://oauth2:$env:GH_TOKEN@github.com/BF3RM/RMLevelLoaderGen.git temp_loader
        cd temp_loader
        
        # 2. BUILD THE TOOL (C#)
        # Even if Python is needed later, the entry point seems to be a C# binary in /bin
        Write-Host "--- Building LevelLoaderGen ---"
        dotnet build .\LevelLoaderGen\LevelLoaderGen.csproj -c Release -o .\LevelLoaderGen\bin
        
        # 3. PATCH generate.bat
        # Remove 'pause', fix slashes
        $content = Get-Content generate.bat -Raw
        $content = $content -replace 'pause', 'REM pause'
        $content = $content -replace '/', '\' 
        Set-Content -Path generate.bat -Value $content

        # 4. EXECUTE generate.bat
        # We run this in a cmd shell to ensure standard Windows behavior
        Write-Host "--- Executing generate.bat ---"
        cmd /c generate.bat

        # 5. FIND AND MOVE OUTPUT
        $Dest = "..\Build\Admin\Mods\rm-levelloader"
        
        if (Test-Path "mods\rm-levelloader") {
            Write-Host "Found output in local mods folder."
            Move-Item -Path "mods\rm-levelloader" -Destination $Dest -Force
        } elseif (Test-Path "$env:USERPROFILE\Documents\Battlefield 3\Server\Admin\Mods\RMLevelLoaderGen\mods\rm-levelloader") {
             Write-Host "Found output in Documents folder."
             Move-Item -Path "$env:USERPROFILE\Documents\Battlefield 3\Server\Admin\Mods\RMLevelLoaderGen\mods\rm-levelloader" -Destination $Dest -Force
        } else {
             Write-Error "FATAL: Could not find generated 'mods\rm-levelloader' folder."
             Get-ChildItem -Recurse
             exit 1
        }

    # --- 6. CONFIG FILES ---
    - name: Generate Config Files
      working-directory: Build/Admin
      env:
        RCON_PW: ${{ secrets.RCON_PASSWORD }} 
        LIC_KEY: ${{ secrets.LICENSE_KEY }}
      run: |
        New-Item -Path "BanList.txt" -ItemType File -Force
        Set-Content -Path "ModList.txt" -Value "RealityMod`r`nrm-levelloader`r`nBlueprintManager`r`nVEManager"

        $mapListContent = @"
        #AAS Layers
        #XP1_001 AdvanceAndSecureStd 1 # Strike at Karkand
        #XP1_002 AdvanceAndSecureStd 1 # Gulf of Oman
        #XP1_003 AdvanceAndSecureStd 1 # Sharqi Peninsula
        #XP1_004 AdvanceAndSecureStd 1 # Wake Island
        #XP3_Desert AdvanceAndSecureStd 1 # Bandar Desert
        #XP3_Shield AdvanceAndSecureStd 6 # Issue 226
        #XP4_Parl AdvanceAndSecureStd 1 # Azadi Palace
        #XP5_001 AdvanceAndSecureStd 1 # Operation Riverside
        XP5_002 AdvanceAndSecureStd 1 # Kandahar
        #XP5_003 AdvanceAndSecureStd 1 # Bay of Gdansk
        #XP5_004 AdvanceAndSecureStd 1 # Chernihivska Oblast Pipeline
        "@
        Set-Content -Path "MapList.txt" -Value $mapListContent

        $startupContent = @"
        # RM Server Startup.txt Example

        admin.password "$env:RCON_PW"
        vars.gamePassword "password"

        vars.serverName "<Server Name>"
        vars.maxPlayers 80
        vu.serverbanner https://i.imgur.com/B4bCwpq.jpg 
        vars.idleTimeout 9999

        vars.teamKillCountForKick 0
        vars.teamKillValueForKick 2
        vars.teamKillValueIncrease 0.525
        vars.teamKillValueDecreasePerSecond 0.01
        vars.teamKillKickForBan 0

        RM.setDevelopers "names" "space" "seperated" 
        RM.setAdmins "[ENTE]VileEnd" "Admin2"
        RM.setLightAdmins "LightAdmin1" "LightAdmin2"
        RM.serverInfo "Sample RM Server Info"
        RM.serverLicenseKey $env:LIC_KEY
        RM.ingameBanner https://i.imgur.com/Vth3wBa.jpg
        RM.pingLimitEnable true
        RM.pingLimitInMs 250
        RM.autoPerfEnabled false
        RM.autoPerfMaxPlayers 80
        RM.tempReservedSlotsEnabled true
        RM.tempReservedSlotsRejoinTime 60.0
        RM.defaultPreRoundTime 180
        RM.setAutoBalancer false

        reservedSlotsList.add "PlayerName1"
        reservedSlotsList.add "PlayerName2"
        "@
        Set-Content -Path "Startup.txt" -Value $startupContent

    # --- 7. FINALIZE ---
    - name: Upload Server Artifact
      uses: actions/upload-artifact@v4
      with:
        name: BF3-Server-Files
        path: Build/